{"meta":{"title":"Will's blog","subtitle":null,"description":"will go everywhere!","author":"willwang","url":"https://willwang.top"},"pages":[{"title":"about","date":"2019-03-10T00:32:43.158Z","updated":"2019-03-10T00:32:43.158Z","comments":true,"path":"about/index.html","permalink":"https://willwang.top/about/index.html","excerpt":"","text":"...... 什么都没有，快来diss他。"},{"title":"我的朋友们","date":"2019-03-09T10:05:50.815Z","updated":"2019-03-09T10:05:50.815Z","comments":true,"path":"friends/index.html","permalink":"https://willwang.top/friends/index.html","excerpt":"","text":"各位大佬想交换友链的话可以在下方留言，必须要有名称、头像链接、和至少一个标签哦～ 名称： Will’s blog头像： https://willwang.top/img/favicons/head.png网址： https://willwang.top标签： java"},{"title":"所有分类","date":"2019-03-10T06:13:15.894Z","updated":"2019-03-10T04:46:01.450Z","comments":true,"path":"categories/index.html","permalink":"https://willwang.top/categories/index.html","excerpt":"","text":""},{"title":"所有标签","date":"2019-03-10T06:13:01.754Z","updated":"2019-03-10T04:45:45.682Z","comments":true,"path":"tags/index.html","permalink":"https://willwang.top/tags/index.html","excerpt":"","text":""},{"title":"","date":"2019-03-10T08:57:40.694Z","updated":"2019-03-10T08:44:42.398Z","comments":true,"path":"assets/plugin/busuanzi/2.3/busuanzi.pure.mini.js","permalink":"https://willwang.top/assets/plugin/busuanzi/2.3/busuanzi.pure.mini.js","excerpt":"","text":"var bszCaller,bszTag;!function(){var c,d,e,a=!1,b=[];ready=function(c){return a||\"interactive\"===document.readyState||\"complete\"===document.readyState?c.call(document):b.push(function(){return c.call(this)}),this},d=function(){for(var a=0,c=b.length;c>a;a++)b[a].apply(document);b=[]},e=function(){a||(a=!0,d.call(window),document.removeEventListener?document.removeEventListener(\"DOMContentLoaded\",e,!1):document.attachEvent&&(document.detachEvent(\"onreadystatechange\",e),window==window.top&&(clearInterval(c),c=null)))},document.addEventListener?document.addEventListener(\"DOMContentLoaded\",e,!1):document.attachEvent&&(document.attachEvent(\"onreadystatechange\",function(){/loaded|complete/.test(document.readyState)&&e()}),window==window.top&&(c=setInterval(function(){try{a||document.documentElement.doScroll(\"left\")}catch(b){return}e()},5)))}(),bszCaller={fetch:function(a,b){var c=\"BusuanziCallback_\"+Math.floor(1099511627776*Math.random());window[c]=this.evalCall(b),a=a.replace(\"=BusuanziCallback\",\"=\"+c),scriptTag=document.createElement(\"SCRIPT\"),scriptTag.type=\"text/javascript\",scriptTag.defer=!0,scriptTag.src=a,document.getElementsByTagName(\"HEAD\")[0].appendChild(scriptTag)},evalCall:function(a){return function(b){ready(function(){try{a(b),scriptTag.parentElement.removeChild(scriptTag)}catch(c){bszTag.hides()}})}}},bszCaller.fetch(\"//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback\",function(a){bszTag.texts(a),bszTag.shows()}),bszTag={bszs:[\"site_pv\",\"page_pv\",\"site_uv\"],texts:function(a){this.bszs.map(function(b){var c=document.getElementById(\"busuanzi_value_\"+b);c&&(c.innerHTML=a[b])})},hides:function(){this.bszs.map(function(a){var b=document.getElementById(\"busuanzi_container_\"+a);b&&(b.style.display=\"none\")})},shows:function(){this.bszs.map(function(a){var b=document.getElementById(\"busuanzi_container_\"+a);b&&(b.style.display=\"inline\")})}};"}],"posts":[{"title":"CentOS6.5下搭建mongodb主、从、仲裁节点副本集实践","slug":"CentOS6-5下搭建mongodb主、从、仲裁节点副本集实践","date":"2019-03-09T16:00:00.000Z","updated":"2019-03-10T08:11:21.881Z","comments":true,"path":"published/2019/03/10/CentOS6-5下搭建mongodb主、从、仲裁节点副本集实践/","link":"","permalink":"https://willwang.top/published/2019/03/10/CentOS6-5下搭建mongodb主、从、仲裁节点副本集实践/","excerpt":"准备工作： 下载mongodb，本次实践版本号mongodb-linux-x86_64-2.6.7.tgz 设置防火墙为允许 准备好配置文件，及生成keyFile文件，开启keyFile就相当于开启auth","text":"准备工作： 下载mongodb，本次实践版本号mongodb-linux-x86_64-2.6.7.tgz 设置防火墙为允许 准备好配置文件，及生成keyFile文件，开启keyFile就相当于开启auth 1 设置配置文件，及生成keyFile文件1.1 设置配置文件主节点/usr/local/mongodb_master/mongodb_master.conf123456789dbpath=/storage/mongodb/masterlogpath=/usr/local/mongodb_master/logs/mongodb.logdirectoryperdb=port=27017maxConns=500smallfiles=truefork=replSet=rs1#keyFile=/usr/local/mongodb_master/keyFile注意：smallfiles= 是设置最小存储空间，用于自测试配置配置文件中：#keyFile=/usr/local/mongodb_master/keyFile，初始时注销掉，不启用备节点/usr/local/mongodb_master/mongodb_slave.conf123456789dbpath=/storage/mongodb/slavelogpath=/usr/local/mongodb_master/logs/mongodb.logdirectoryperdb=port=27018maxConns=500smallfiles=fork=replSet=rs1#keyFile=/usr/local/mongodb_slave/keyFile仲裁节点/usr/local/mongodb_master/mongodb_arbiter.conf123456789dbpath=/storage/mongodb/arbiterlogpath=/usr/local/mongodb_arbiter/logs/mongodb.logdirectoryperdb=port=27019maxConns=500smallfiles=fork=replSet=rs1#keyFile=/usr/local/mongodb_arbiter/keyFile 1.2 生成keyFile文件keyFile文件的作用： 集群之间的安全认证，增加安全认证机制KeyFile（开启keyfile认证就默认开启了auth认证） openssl rand -base64 741 &gt; keyFile #生成keyFile chmod 600 keyFile #设置权限，不能太大 scp –r keyFile root@host:/usr/local/mongodb_arbiter/keyFile ## 复制到所有节点 2 初始化副本集2.1 初始化单点初始化：123456rscfg = &#123; _id:\"rs1\", members:[&#123; _id:0, host:\"192.168.1.78:27017\"&#125;]&#125;rs.initiate( rscfg ) 多节点初始化:12345678rscfg = &#123; _id:\"rs1\", members:[&#123; _id:0, host:\"192.168.1.71:27017\", priority:2&#125;,&#123; _id:1, host:\"192.168.1.82:27018\", priority:1&#125;,&#123; _id:2, host:\"192.168.1.71:27019\", arbiterOnly:true&#125;]&#125;rs.initiate( rscfg ) 2.2 单节点初始化后：添加、删除节点操作123456789添加secondary：rs.add(&#123;host: \"192.168.1.78:27018\", priority: 1 &#125;)添加仲裁点：rs.addArb(\"192.168.1.78:27019\")移除节点：rs.remove(&#123;host: \"192.168.1.78:27019\"&#125;)重置节点权限：conf=rscfg.conf()conf.members[0].priority=2rs.reconfig(config)查看集群配置：rs.conf();查看集群状态：rs.status(); 3 添加管理员用户及普通用户,并进行验证(在rs1:PRIMARY上操作)注意：需要在主节点(PRIMARY)操作;帐号是跟着库走的，所以在指定库里授权，必须也在指定库里验证(auth)创建用户管理员:123456789admin = db.getSiblingDB(\"admin\"); #其中getSiblingDB为获取另一个数据库对象admin.createUser( &#123; user: \"admin\", pwd: \"admin\", roles: [ &#123; role: \"userAdminAnyDatabase\", db: \"admin\" &#125; ] &#125;)admin.auth(\"admin\", \"admin\" ); 创建集群管理员:12345678admin.createUser( &#123; user: \"username\", pwd: \"pwd\", roles: [ &#123; role: \"clusterAdmin\", db: \"admin\" &#125; ] &#125;)admin.auth(\"username\", \"pwd\" ); 其他用户相关操作 更新用户：db.getSiblingDB(“admin”);updateUser(“username”,{roles: [ { role: “userAdminAnyDatabase”, db: “admin” } ]}) 验证用户：db.getSiblingDB(“admin”).auth(“username”, “pwd” ) 修改密码：db.changeUserPassword(“username”,”pwd”); 集群及其他角色授权： 1234db.grantRolesToUser( \"admin\" , [ &#123; \"role\": \"clusterAdmin\", \"db\": \"admin\" &#125;,&#123; \"role\": \"userAdminAnyDatabase\", \"db\": \"admin\" &#125;,&#123; \"role\": \"dbAdminAnyDatabase\", \"db\": \"admin\" &#125;,&#123; role: \"root\", db: \"admin\" &#125; ]) 如果是admin，可以额外添加： 1&#123; role: \"dbOwner\", db: \"admin\" &#125; 加上dbOwner可以直接操作其他数据库如replSetTest，不需要重新认证 db.auth(‘admin’,’admin’) 4 重启集群由于关闭主节点，则主节点状态会切到副本集中的从节点，因此，先关闭从节点，最后关闭主节点。db.getSiblingDB(“admin”).shutdownServer(); 或ps -ef | grep mongo, kill +pid 取消所有节点配置文件中的注释，keyFile=/usr/local/mongodb_arbiter/keyFile重新启动服务 如果启动异常，删除mongo.lock, rm -f mongo.lock，重新启动 5 验证登录主节点：12345rs1:PRIMARY&gt;rs.status();显示：not authorized for queryrs1:PRIMARY&gt;db.getSiblingDB(\"admin\").auth(\"username\", \"pwd\" );授权后，可进行操作rs1:PRIMARY&gt;db.t1.insert(&#123;\"name\":\"zs\",\"age\":11&#125;) 登录从节点查看是否同步：12345rs1:SECONDARY&gt;db.t1.find() #显示：not authorized for query on test.t1\"rs1:SECONDARY&gt;db.getSiblingDB(\"admin\").auth(\"username\", \"pwd\" ); #验证rs1:SECONDARY&gt;db.t1.find(); #not master and slaveOk=false\"rs1:SECONDARY&gt;db.setSlaveOk(); #读权限rs1:SECONDARY&gt;db.t1.find(); #查询所有记录 注意：授权操作过程 rs1:PRIMARY&gt;rs.conf() # 访问异常,not authorized for query on test.t1”rs1:PRIMARY&gt;use admin #切换数据库rs1:PRIMARY&gt;db.auth(“username”, “pwd” ); #授权rs1:PRIMARY&gt;use test #切换其他库rs1:PRIMARY&gt;rs.conf() #正常访问 6 java测试副本集连接代码12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455public class TestMongo&#123; private static MongoClient mongoClient = null; public DB getDB() throws UnknownHostException &#123; DB conn = null; if (mongoClient == null) &#123; intializeMongoClient(); &#125; conn = mongoClient.getDB(\"testdb\"); return conn; &#125; private static void intializeMongoClient() throws UnknownHostException &#123; MongoClientURI mongoClientURI = new MongoClientURI(\"mongodb://username:pwd@192.168.1.78: 27017,192.168.1.78: 27018,192.168.1.78: 27019/admin\");// MongoClientURI mongoClientURI = new MongoClientURI(\"mongodb://192.168.1.78: 27017\"); mongoClient = new MongoClient(mongoClientURI); &#125; public synchronized void closeConnection() &#123; if (mongoClient != null) &#123; mongoClient.close(); &#125; &#125; public static void main(String[] args) &#123; TestMongo testMongo = new TestMongo(); DBObject content=new BasicDBObject(); content.put(\"name\",\"北京4\"); content.put(\"type\",\"首都\"); try &#123; DB db = testMongo.getDB(); DBCollection collection=db.getCollection(\"n1\"); collection.insert(content); long count = collection.getCount(); System.out.println(count); testMongo.closeConnection(); &#125; catch (UnknownHostException e) &#123; e.printStackTrace(); &#125; &#125;&#125; Ref Enforce Keyfile Access Control in a Replica Set Enable Authentication in a Sharded Cluster mongodb之replSet复制集 + auth mongodb副本集用户权限设置 Mongodb集群搭建及spring和java连接配置记录","categories":[{"name":"数据库","slug":"数据库","permalink":"https://willwang.top/categories/数据库/"},{"name":"mongodb","slug":"数据库/mongodb","permalink":"https://willwang.top/categories/数据库/mongodb/"}],"tags":[{"name":"mongodb","slug":"mongodb","permalink":"https://willwang.top/tags/mongodb/"}]},{"title":"Welcome to my blog","slug":"welcome","date":"2019-03-09T16:00:00.000Z","updated":"2019-03-10T04:39:26.443Z","comments":true,"path":"published/2019/03/10/welcome/","link":"","permalink":"https://willwang.top/published/2019/03/10/welcome/","excerpt":"","text":"欢迎访问我的博客，希望留下你美丽的足记。","categories":[],"tags":[{"name":"欢迎","slug":"欢迎","permalink":"https://willwang.top/tags/欢迎/"}]}]}