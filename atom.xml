<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Will&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://willwang.top/"/>
  <updated>2019-03-24T09:11:36.356Z</updated>
  <id>https://willwang.top/</id>
  
  <author>
    <name>willwang</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CentOS6.5 配置Iptables</title>
    <link href="https://willwang.top/published/2019/03/24/CentOS6-5-%E9%85%8D%E7%BD%AEIptables/"/>
    <id>https://willwang.top/published/2019/03/24/CentOS6-5-配置Iptables/</id>
    <published>2019-03-23T16:00:00.000Z</published>
    <updated>2019-03-24T09:11:36.356Z</updated>
    
    <content type="html"><![CDATA[<p>要求：内网服务器需要进行访问限制，配置防火墙可以方便、简单地实现功能。如开放某个服务或其他特定端口，允许一段ip地址访问，禁止另一段ip地址访问。</p><a id="more"></a><h2 id="1-确定开启的服务及端口"><a href="#1-确定开启的服务及端口" class="headerlink" title="1. 确定开启的服务及端口"></a>1. 确定开启的服务及端口</h2><p>HTTP (TCP on port 80), HTTPS (TCP on port 443), SSH (TCP on port 22 by default), NTP (UDP on port 123), DNS (TCP and UDP on port 53), ping (ICMP),telnet(23),ftp (21,20,1024),mysql (3306),mongo (27017)</p><p>iptables配置文件路径： <code>/etc/sysconfig/iptables</code></p><h2 id="2-配置规则"><a href="#2-配置规则" class="headerlink" title="2. 配置规则"></a>2. 配置规则</h2><figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 查看iptables配置信息</span></span><br><span class="line">iptables -L -n</span><br><span class="line"></span><br><span class="line"><span class="meta"># 清除配置规则    -F: 清除默认所有, -X:清除自定义, -Z:清空计数器值</span></span><br><span class="line">iptables -F<span class="comment">; iptables -X; iptables -Z</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 允许本地回环访问</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -i lo -j ACCEPT</span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -d <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">8</span> -j REJECT</span><br><span class="line"></span><br><span class="line"><span class="meta"># 阻止通用攻击</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp ! --syn -m state --state NEW -j DROP</span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --tcp-flags ALL NONE -j DROP</span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --tcp-flags ALL ALL -j DROP</span><br><span class="line"></span><br><span class="line"><span class="meta"># 允许已建立的入站连接</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="meta"># 允许http和https</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --dport <span class="number">80</span> -j ACCEPT</span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --dport <span class="number">443</span> -j ACCEPT</span><br><span class="line"><span class="meta"># 允许ssh</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --dport <span class="number">22</span> -j ACCEPT</span><br><span class="line"><span class="meta"># 允许ntp</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p udp --dport <span class="number">123</span> -j ACCEPT</span><br><span class="line"><span class="meta"># 允许dns</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p udp --dport <span class="number">53</span> -j ACCEPT</span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --dport <span class="number">53</span> -j ACCEPT</span><br><span class="line"><span class="meta"># 允许ping包</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p icmp --icmp-type echo-request -j ACCEPT</span><br><span class="line"><span class="meta"># 允许telnet</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --dport <span class="number">23</span> -j ACCEPT</span><br><span class="line"><span class="meta"># 允许ftp <span class="number">21</span>:ftp <span class="number">20</span>:active mode   <span class="number">1024</span>:Passive mode</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --dport <span class="number">20</span> -j ACCEPT</span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --dport <span class="number">21</span> -j ACCEPT</span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --dport <span class="number">1024</span> -j ACCEPT</span><br><span class="line"><span class="meta"># 允许mysql</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --dport <span class="number">3306</span> -j ACCEPT</span><br><span class="line"><span class="meta"># 允许mongo</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp --dport <span class="number">27017</span> -j ACCEPT</span><br><span class="line"><span class="meta"># 允许特定ip+port访问</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp -s <span class="number">192.168</span><span class="number">.1</span><span class="number">.78</span> --dport <span class="number">22</span> -j ACCEPT</span><br><span class="line"><span class="meta"># 禁止特定ip+其他端口访问(注意：禁止其他端口需要在允许特定端口之后配置)</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -p tcp -s <span class="number">192.168</span><span class="number">.1</span><span class="number">.78</span> -j DROP</span><br><span class="line"><span class="meta"># 允许多个ip访问</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -i eth1 -m iprange --src-range <span class="number">192.168</span><span class="number">.1</span><span class="number">.81</span><span class="number">-192.168</span><span class="number">.1</span><span class="number">.90</span> -j ACCEPT</span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -i eth1 -s <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span> -j ACCEPT</span><br><span class="line"><span class="meta"># 阻止多个ip访问</span></span><br><span class="line">iptables -A <span class="keyword">INPUT</span> -m iprange --src-range <span class="number">192.168</span><span class="number">.1</span><span class="number">.71</span><span class="number">-192.168</span><span class="number">.1</span><span class="number">.80</span> -j DROP</span><br><span class="line"><span class="meta">#封停一个IP，-I是插入到最前面</span></span><br><span class="line">iptables -I <span class="keyword">INPUT</span> -s <span class="number">192.168</span><span class="number">.1</span><span class="number">.78</span> -j DROP</span><br><span class="line"><span class="meta">#要解封一个IP</span></span><br><span class="line">iptables -D <span class="keyword">INPUT</span> -s <span class="number">192.168</span><span class="number">.1</span><span class="number">.78</span> -j DROP</span><br><span class="line"></span><br><span class="line"><span class="meta"># 设置默认规则</span></span><br><span class="line"><span class="meta"># 丢掉其他入站包，允许所有出栈包，丢掉所有转发包</span></span><br><span class="line">iptables -P <span class="keyword">INPUT</span> DROP</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line">iptables -P FORWARD DROP</span><br></pre></td></tr></table></figure><h2 id="3-保存"><a href="#3-保存" class="headerlink" title="3. 保存"></a>3. 保存</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存配置</span></span><br><span class="line">service iptables save</span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">service iptables restart</span><br></pre></td></tr></table></figure><h2 id="4-其他相关命令"><a href="#4-其他相关命令" class="headerlink" title="4. 其他相关命令"></a>4. 其他相关命令</h2><h3 id="4-1-修改规则"><a href="#4-1-修改规则" class="headerlink" title="4.1 修改规则"></a>4.1 修改规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看需要删除的规则及序号</span></span><br><span class="line">iptables -L -n --line-number</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除指定端口规则对应的序列号</span></span><br><span class="line">iptables -D INPUT 5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 确认是否删除</span></span><br><span class="line">iptables -L -n --line-number</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新配置</span></span><br></pre></td></tr></table></figure><h3 id="4-2-iptables相关命令"><a href="#4-2-iptables相关命令" class="headerlink" title="4.2 iptables相关命令"></a>4.2 iptables相关命令</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开机自启/关闭</span></span><br><span class="line">chkconfig iptables on|off</span><br><span class="line"><span class="comment"># 启动/关闭/重启 服务</span></span><br><span class="line">service iptables start|stop|restart</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">service iptables status</span><br></pre></td></tr></table></figure><h2 id="5-iptables帮助命令"><a href="#5-iptables帮助命令" class="headerlink" title="5. iptables帮助命令"></a>5. iptables帮助命令</h2><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">iptables(选项)(参数)</span><br><span class="line"></span><br><span class="line">-<span class="ruby">t&lt;表&gt;：指定要操纵的表；</span></span><br><span class="line"><span class="ruby">-A：向规则链中添加或追加条目；</span></span><br><span class="line"><span class="ruby">-D：从规则链中删除条目；</span></span><br><span class="line"><span class="ruby">-i：向规则链中插入条目；</span></span><br><span class="line"><span class="ruby">-R：替换规则链中的条目；</span></span><br><span class="line"><span class="ruby">-L：显示规则链中已有的条目；</span></span><br><span class="line"><span class="ruby">-F：清楚规则链中已有的条目；</span></span><br><span class="line"><span class="ruby">-Z：清空规则链中的数据包计算器和字节计数器；</span></span><br><span class="line"><span class="ruby">-N：创建新的用户自定义规则链；</span></span><br><span class="line"><span class="ruby">-P：定义规则链中的默认目标；</span></span><br><span class="line"><span class="ruby">-h：显示帮助信息；</span></span><br><span class="line"><span class="ruby">-p：指定要匹配的数据包协议类型；</span></span><br><span class="line"><span class="ruby">-s：指定要匹配的数据包源ip地址；</span></span><br><span class="line"><span class="ruby">-j&lt;目标&gt;：指定要跳转的目标；</span></span><br><span class="line"><span class="ruby">-i&lt;网络接口&gt;：指定数据包进入本机的网络接口；</span></span><br><span class="line"><span class="ruby">-o&lt;网络接口&gt;：指定数据包要离开本机所使用的网络接口。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">iptables命令选项输入顺序：</span></span><br><span class="line"><span class="ruby">iptables -t 表名 &lt;-A/I/D/R&gt; 规则链名 [规则号] &lt;-i/o 网卡名&gt; -p 协议名 &lt;-s 源IP/源子网&gt; --sport 源端口 &lt;-d 目标IP/目标子网&gt; --dport 目标端口 -j 动作</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">表名包括：</span></span><br><span class="line"><span class="ruby">raw：高级功能，如：网址过滤。</span></span><br><span class="line"><span class="ruby">mangle：数据包修改（QOS），用于实现服务质量。</span></span><br><span class="line"><span class="ruby">net：地址转换，用于网关路由器。</span></span><br><span class="line"><span class="ruby">filter：包过滤，用于防火墙规则，默认为filter。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">规则链名包括：</span></span><br><span class="line"><span class="ruby">INPUT链：处理输入数据包。</span></span><br><span class="line"><span class="ruby">OUTPUT链：处理输出数据包。</span></span><br><span class="line"><span class="ruby">PORWARD链：处理转发数据包。</span></span><br><span class="line"><span class="ruby">PREROUTING链：用于目标地址转换（DNAT）。</span></span><br><span class="line"><span class="ruby">POSTOUTING链：用于源地址转换（SNAT）。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">动作包括：</span></span><br><span class="line"><span class="ruby">accept：接收数据包。</span></span><br><span class="line"><span class="ruby">DROP：丢弃数据包。</span></span><br><span class="line"><span class="ruby">REDIRECT：重定向、映射、透明代理。</span></span><br><span class="line"><span class="ruby">SNAT：源地址转换。</span></span><br><span class="line"><span class="ruby">DNAT：目标地址转换。</span></span><br><span class="line"><span class="ruby">MASQUERADE：IP伪装（NAT），用于ADSL。</span></span><br><span class="line"><span class="ruby">LOG：日志记录。</span></span><br></pre></td></tr></table></figure><h2 id="6-Ref"><a href="#6-Ref" class="headerlink" title="6. Ref"></a>6. Ref</h2><ol><li><a href="http://man.linuxde.net/iptables" target="_blank" rel="noopener">iptables命令</a></li><li><a href="https://www.vultr.com/docs/setup-iptables-firewall-on-centos-6" target="_blank" rel="noopener">Setup IPTables Firewall on CentOS 6</a></li><li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-using-firewalld-on-centos-7" target="_blank" rel="noopener">How To Set Up a Firewall Using FirewallD on CentOS 7</a></li><li><a href="https://www.vultr.com/docs/changing-your-ssh-port-for-extra-security-on-centos-6-or-7" target="_blank" rel="noopener">Changing Your SSH Port For Extra Security on CentOS 6 or 7</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;要求：内网服务器需要进行访问限制，配置防火墙可以方便、简单地实现功能。如开放某个服务或其他特定端口，允许一段ip地址访问，禁止另一段ip地址访问。&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="https://willwang.top/categories/Linux/"/>
    
      <category term="linux配置" scheme="https://willwang.top/categories/Linux/linux%E9%85%8D%E7%BD%AE/"/>
    
    
      <category term="iptables" scheme="https://willwang.top/tags/iptables/"/>
    
  </entry>
  
  <entry>
    <title>Deep Learning basics p1: Introduction to Deep Learning</title>
    <link href="https://willwang.top/published/2019/03/20/Deep-Learning-basics-p1-Introduction-to-Deep-Learning/"/>
    <id>https://willwang.top/published/2019/03/20/Deep-Learning-basics-p1-Introduction-to-Deep-Learning/</id>
    <published>2019-03-19T16:00:00.000Z</published>
    <updated>2019-03-24T09:16:08.509Z</updated>
    
    <content type="html"><![CDATA[<p>通过python、Tensorflow和Keras框架实现的深度学习实例。本文是深度学习的快速入门的第一章，简单介绍神经网络的实现原理，利用tensorflow，采用Keras模型对mnist数据集进行构建，训练和预测流程的简单实现。</p><a id="more"></a><p>简单总结下，不一定正确，只为加深印象。一般包括以下几个步骤：</p><ol><li>导包</li><li>实例化数据集</li><li>建立模型</li><li>配置学习模型</li><li>训练模型</li><li>测试样本</li><li>保存模型</li><li>进行预测</li></ol><p>示例代码如下。</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 导包</span></span><br><span class="line"><span class="built_in">import</span> tensorflow as tf <span class="comment">#deep learning library. Tensors are just multi-dimensional arrays</span></span><br><span class="line"><span class="built_in">import</span> matplotlib.pyplot as plt</span><br><span class="line"><span class="built_in">import</span> numpy as np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 实例化数据集</span></span><br><span class="line"><span class="attr">mnist</span> = tf.keras.datasets.mnist <span class="comment"># mnist is a dataset of 28x28 images of handwritten digits and their labels</span></span><br><span class="line"></span><br><span class="line">(x_train, y_train), (x_test, y_test) = mnist.load_data() <span class="comment"># unpacks images to x_train/x_test and labels to y_train/y_test</span></span><br><span class="line"><span class="comment"># print(x_train[0])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 归一化处理，使取值范围在[0, 1]或[-1, 1]</span></span><br><span class="line"><span class="attr">x_train</span> = tf.keras.utils.normalize(x_train, <span class="attr">axis=1)</span> <span class="comment"># scales data between 0 and 1</span></span><br><span class="line"><span class="attr">x_test</span> = tf.keras.utils.normalize(x_test, <span class="attr">axis=1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(x_train[0])</span></span><br><span class="line"><span class="comment"># imshow是设置图片的展示，cmap意思是color map，颜色方案，binary代表是白底黑字；</span></span><br><span class="line"><span class="comment"># plt.imshow(x_train[0], cmap = plt.cm.binary)</span></span><br><span class="line"><span class="comment"># plt.show()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 建立模型</span></span><br><span class="line"><span class="attr">model</span> = tf.keras.models.Sequential()    <span class="comment"># a basic feed-forward model</span></span><br><span class="line">model.add(tf.keras.layers.Flatten()) <span class="comment"># flatten date ,takes our 28x28 and makes it 1x784  #</span></span><br><span class="line"><span class="comment"># Adds a densely-connected layer with 128 units to the model:</span></span><br><span class="line">model.add(tf.keras.layers.Dense(<span class="number">128</span>, <span class="attr">activation=tf.nn.relu))</span></span><br><span class="line">model.add(tf.keras.layers.Dense(<span class="number">128</span>, <span class="attr">activation=tf.nn.relu))</span></span><br><span class="line"><span class="comment"># Add a softmax layer with 10 output units:</span></span><br><span class="line">model.add(tf.keras.layers.Dense(<span class="number">10</span>, <span class="attr">activation=tf.nn.softmax))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 配置学习模型</span></span><br><span class="line">model.compile(<span class="attr">optimizer='adam',</span> <span class="comment"># Good default optimizer to start with  #优化器</span></span><br><span class="line">            <span class="attr">loss='sparse_categorical_crossentropy',#</span> how will we calculate our <span class="string">"error."</span> Neural network aims to minimize loss.   <span class="comment">#优化期间最小化的函数</span></span><br><span class="line">            <span class="comment"># sparse: 稀疏的   categorical:绝对的，无条件的，分类的 crossentropy:交叉熵</span></span><br><span class="line">            <span class="attr">metrics=['accuracy'])</span> <span class="comment"># what to track #用于监控训练</span></span><br><span class="line"><span class="comment"># 5 训练模型 循环轮次：3</span></span><br><span class="line">model.fit(x_train, y_train, <span class="attr">epochs=3)</span>   <span class="comment"># train the model</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6 测试样本</span></span><br><span class="line">val_loss, <span class="attr">val_acc</span> = model.evaluate(x_test, y_test)  <span class="comment"># evaluate the out of sample data with model</span></span><br><span class="line">print(val_loss)  <span class="comment"># model's loss (error)</span></span><br><span class="line">print(val_acc)  <span class="comment"># model's accuracy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7 保存</span></span><br><span class="line">model.save('epic_num_reader.model')</span><br><span class="line"><span class="comment"># 重新实例化模型，会创建一个完全一样的模型</span></span><br><span class="line"><span class="attr">new_model</span> = tf.keras.models.load_model('epic_num_reader.model')</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8 预测</span></span><br><span class="line"><span class="attr">predictions</span> = new_model.predict(x_test)</span><br><span class="line">print(predictions)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示数字</span></span><br><span class="line">print(np.argmax(predictions[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示数字图像</span></span><br><span class="line">plt.imshow(x_test[<span class="number">0</span>], <span class="attr">cmap</span> = plt.cm.binary)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p>原文：<a href="https://pythonprogramming.net/introduction-deep-learning-python-tensorflow-keras/" target="_blank" rel="noopener">Introduction to Deep Learning - Deep Learning basics with Python, TensorFlow and Keras p.1</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;通过python、Tensorflow和Keras框架实现的深度学习实例。本文是深度学习的快速入门的第一章，简单介绍神经网络的实现原理，利用tensorflow，采用Keras模型对mnist数据集进行构建，训练和预测流程的简单实现。&lt;/p&gt;
    
    </summary>
    
      <category term="AI" scheme="https://willwang.top/categories/AI/"/>
    
      <category term="DL basic" scheme="https://willwang.top/categories/AI/DL-basic/"/>
    
    
      <category term="DL basic" scheme="https://willwang.top/tags/DL-basic/"/>
    
  </entry>
  
  <entry>
    <title>win7下安装Anaconda3和tensorflow</title>
    <link href="https://willwang.top/published/2019/03/19/win7%E4%B8%8B%E5%AE%89%E8%A3%85Anaconda3%E5%92%8Ctensorflow/"/>
    <id>https://willwang.top/published/2019/03/19/win7下安装Anaconda3和tensorflow/</id>
    <published>2019-03-18T16:00:00.000Z</published>
    <updated>2019-03-24T09:19:00.135Z</updated>
    
    <content type="html"><![CDATA[<p>win7搭建Anaconda3及tensorflow环境<br>其中：本地python为v3.6.5, Anaconda3为Anaconda3-5.2.0-Windows-x86_64</p><a id="more"></a><h2 id="1-安装python"><a href="#1-安装python" class="headerlink" title="1   安装python"></a>1   安装python</h2><p>python3和python2环境变量共存设置<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span>Pytho<span class="symbol">n3</span><span class="meta">%</span>;<span class="meta">%</span>Pytho<span class="symbol">n3</span><span class="meta">%</span>\Scripts;<span class="meta">%</span>Pytho<span class="symbol">n2</span><span class="meta">%</span>;<span class="meta">%</span>Pytho<span class="symbol">n2</span><span class="meta">%</span>\Scripts;</span><br></pre></td></tr></table></figure></p><h2 id="2-安装及配置pip"><a href="#2-安装及配置pip" class="headerlink" title="2   安装及配置pip"></a>2   安装及配置pip</h2><p>安装及升级<br>python -m pip install –upgrade pip</p><p>国内pip源<br>清华：<a href="https://pypi.tuna.tsinghua.edu.cn/simple" target="_blank" rel="noopener">https://pypi.tuna.tsinghua.edu.cn/simple</a><br>阿里云：<a href="http://mirrors.aliyun.com/pypi/simple/" target="_blank" rel="noopener">http://mirrors.aliyun.com/pypi/simple/</a><br>中国科技大学 <a href="https://pypi.mirrors.ustc.edu.cn/simple/" target="_blank" rel="noopener">https://pypi.mirrors.ustc.edu.cn/simple/</a><br>华中理工大学：<a href="http://pypi.hustunique.com/" target="_blank" rel="noopener">http://pypi.hustunique.com/</a><br>山东理工大学：<a href="http://pypi.sdutlinux.org/" target="_blank" rel="noopener">http://pypi.sdutlinux.org/</a><br>豆瓣：<a href="http://pypi.douban.com/simple/" target="_blank" rel="noopener">http://pypi.douban.com/simple/</a></p><p>更改pip源<br>windows环境下，添加或修改为：<br><figure class="highlight vim"><figcaption><span>C:\Users\will\pip\pip.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">global</span>]</span><br><span class="line"><span class="built_in">index</span>-url = http<span class="variable">s:</span>//pypi.tuna.tsinghua.edu.<span class="keyword">cn</span>/simple</span><br></pre></td></tr></table></figure></p><p>linux环境下,添加或修改为：<br><figure class="highlight vim"><figcaption><span>$HOME/pip/pip.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">global</span>]</span><br><span class="line"><span class="built_in">index</span>-url = http<span class="variable">s:</span>//pypi.tuna.tsinghua.edu.<span class="keyword">cn</span>/simple</span><br></pre></td></tr></table></figure></p><h2 id="3-安装及配置Anaconda3"><a href="#3-安装及配置Anaconda3" class="headerlink" title="3   安装及配置Anaconda3"></a>3   安装及配置Anaconda3</h2><h3 id="3-1-下载Anaconda3"><a href="#3-1-下载Anaconda3" class="headerlink" title="3.1 下载Anaconda3"></a>3.1 下载Anaconda3</h3><p><a href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/" target="_blank" rel="noopener">Anaconda3-5.2.0</a>,进行安装</p><h3 id="3-2-配置Anaconda3环境变量"><a href="#3-2-配置Anaconda3环境变量" class="headerlink" title="3.2 配置Anaconda3环境变量"></a>3.2 配置Anaconda3环境变量</h3><p>新建系统变量：<code>ANACONDA3</code> 为 <code>C:/MyProgramFiles/Anaconda3</code><br>在Path添加<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%ANACONDA3%;%ANACONDA3%/Library/mingw-w64/bin;%ANACONDA3%/Library/bin;%ANACONDA3%/Scripts;</span><br></pre></td></tr></table></figure></p><p>参考后，目前没有配置：<code>%ANACONDA3%/Library/usr/bin</code>，原因：没找到路径,可能是win没有。</p><p>测试是否配置成功：命令行下输入:conda</p><h3 id="3-3-登录jupyter"><a href="#3-3-登录jupyter" class="headerlink" title="3.3 登录jupyter"></a>3.3 登录jupyter</h3><p>运行Jupyter Notebook。<br>看到<code>http://localhost:8888/?token=...</code>表示成功</p><h3 id="3-4-修改coanda包管理源"><a href="#3-4-修改coanda包管理源" class="headerlink" title="3.4 修改coanda包管理源"></a>3.4 修改coanda包管理源</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">conda config --<span class="built_in">add</span> channels http<span class="variable">s:</span>//mirrors.tuna.tsinghua.edu.<span class="keyword">cn</span>/anaconda/pkgs/free/</span><br><span class="line">conda config --<span class="built_in">add</span> channels http<span class="variable">s:</span>//mirrors.tuna.tsinghua.edu.<span class="keyword">cn</span>/anaconda/pkgs/main/</span><br><span class="line">conda config --<span class="keyword">set</span> show_channel_urls yes</span><br></pre></td></tr></table></figure><p>可能有用，coanda删除源<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">coanda <span class="built_in">config</span> --<span class="built_in">remove</span> channels https:<span class="comment">//error……</span></span><br></pre></td></tr></table></figure></p><h2 id="4-安装tensorflow"><a href="#4-安装tensorflow" class="headerlink" title="4    安装tensorflow"></a>4    安装tensorflow</h2><p>tensorflow版本分为：</p><ul><li>CPU版本：pip3 install –upgrade tensorflow</li><li>GPU版本：pip3 install –upgrade tensorflow-gpu（电脑不支持）</li></ul><p>安装cpu版本<br>pip install –upgrade tensorflow</p><p>tensorflow安装成功测试<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; import tensorflow as tf</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; hello = tf.constant(<span class="string">'Hello, TensorFlow!'</span>)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; sess = tf.Session()</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; <span class="built_in">print</span>(sess.run(hello))</span></span><br></pre></td></tr></table></figure></p><p>Ref</p><ol><li><a href="https://www.cnblogs.com/amanda-x/p/7739467.html" target="_blank" rel="noopener">Anaconda安装与环境配置</a></li><li><a href="https://blog.csdn.net/jay100500/article/details/72792636" target="_blank" rel="noopener">TensorFlow在Windows环境下的搭建</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;win7搭建Anaconda3及tensorflow环境&lt;br&gt;其中：本地python为v3.6.5, Anaconda3为Anaconda3-5.2.0-Windows-x86_64&lt;/p&gt;
    
    </summary>
    
      <category term="AI" scheme="https://willwang.top/categories/AI/"/>
    
      <category term="环境搭建" scheme="https://willwang.top/categories/AI/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    
    
      <category term="环境搭建" scheme="https://willwang.top/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    
  </entry>
  
  <entry>
    <title>CentOS6.5下搭建mongodb主、从、仲裁节点副本集实践</title>
    <link href="https://willwang.top/published/2019/03/10/CentOS6-5%E4%B8%8B%E6%90%AD%E5%BB%BAmongodb%E4%B8%BB%E3%80%81%E4%BB%8E%E3%80%81%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9%E5%89%AF%E6%9C%AC%E9%9B%86%E5%AE%9E%E8%B7%B5/"/>
    <id>https://willwang.top/published/2019/03/10/CentOS6-5下搭建mongodb主、从、仲裁节点副本集实践/</id>
    <published>2019-03-09T16:00:00.000Z</published>
    <updated>2019-03-10T08:11:21.881Z</updated>
    
    <content type="html"><![CDATA[<p>准备工作：</p><ul><li>下载mongodb，本次实践版本号mongodb-linux-x86_64-2.6.7.tgz</li><li>设置防火墙为允许</li><li>准备好配置文件，及生成keyFile文件，开启keyFile就相当于开启auth</li></ul><a id="more"></a><h2 id="1-设置配置文件，及生成keyFile文件"><a href="#1-设置配置文件，及生成keyFile文件" class="headerlink" title="1   设置配置文件，及生成keyFile文件"></a>1   设置配置文件，及生成keyFile文件</h2><h3 id="1-1-设置配置文件"><a href="#1-1-设置配置文件" class="headerlink" title="1.1 设置配置文件"></a>1.1 设置配置文件</h3><p>主节点<br><figure class="highlight ini"><figcaption><span>/usr/local/mongodb_master/mongodb_master.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dbpath</span>=/storage/mongodb/master</span><br><span class="line"><span class="attr">logpath</span>=/usr/local/mongodb_master/logs/mongodb.log</span><br><span class="line"><span class="attr">directoryperdb</span>=</span><br><span class="line"><span class="attr">port</span>=<span class="number">27017</span></span><br><span class="line"><span class="attr">maxConns</span>=<span class="number">500</span></span><br><span class="line"><span class="attr">smallfiles</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">fork</span>=</span><br><span class="line"><span class="attr">replSet</span>=rs1</span><br><span class="line"><span class="comment">#keyFile=/usr/local/mongodb_master/keyFile</span></span><br></pre></td></tr></table></figure><br><strong>注意：</strong>smallfiles= 是设置最小存储空间，用于自测试配置<br>配置文件中：<code>#keyFile=/usr/local/mongodb_master/keyFile，初始时注销掉，不启用</code><br>备节点<br><figure class="highlight ini"><figcaption><span>/usr/local/mongodb_master/mongodb_slave.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dbpath</span>=/storage/mongodb/slave</span><br><span class="line"><span class="attr">logpath</span>=/usr/local/mongodb_master/logs/mongodb.log</span><br><span class="line"><span class="attr">directoryperdb</span>=</span><br><span class="line"><span class="attr">port</span>=<span class="number">27018</span></span><br><span class="line"><span class="attr">maxConns</span>=<span class="number">500</span></span><br><span class="line"><span class="attr">smallfiles</span>=</span><br><span class="line"><span class="attr">fork</span>=</span><br><span class="line"><span class="attr">replSet</span>=rs1</span><br><span class="line"><span class="comment">#keyFile=/usr/local/mongodb_slave/keyFile</span></span><br></pre></td></tr></table></figure><br>仲裁节点<br><figure class="highlight ini"><figcaption><span>/usr/local/mongodb_master/mongodb_arbiter.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dbpath</span>=/storage/mongodb/arbiter</span><br><span class="line"><span class="attr">logpath</span>=/usr/local/mongodb_arbiter/logs/mongodb.log</span><br><span class="line"><span class="attr">directoryperdb</span>=</span><br><span class="line"><span class="attr">port</span>=<span class="number">27019</span></span><br><span class="line"><span class="attr">maxConns</span>=<span class="number">500</span></span><br><span class="line"><span class="attr">smallfiles</span>=</span><br><span class="line"><span class="attr">fork</span>=</span><br><span class="line"><span class="attr">replSet</span>=rs1</span><br><span class="line"><span class="comment">#keyFile=/usr/local/mongodb_arbiter/keyFile</span></span><br></pre></td></tr></table></figure></p><h3 id="1-2-生成keyFile文件"><a href="#1-2-生成keyFile文件" class="headerlink" title="1.2 生成keyFile文件"></a>1.2 生成keyFile文件</h3><p>keyFile文件的作用： 集群之间的安全认证，增加安全认证机制KeyFile（开启keyfile认证就默认开启了auth认证）</p><ol><li>openssl rand -base64 741 &gt; keyFile #生成keyFile</li><li>chmod 600 keyFile #设置权限，不能太大</li><li>scp –r keyFile root@host:/usr/local/mongodb_arbiter/keyFile ## 复制到所有节点</li></ol><h2 id="2-初始化副本集"><a href="#2-初始化副本集" class="headerlink" title="2   初始化副本集"></a>2   初始化副本集</h2><h3 id="2-1-初始化"><a href="#2-1-初始化" class="headerlink" title="2.1 初始化"></a>2.1 初始化</h3><p>单点初始化：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rscfg = &#123; </span><br><span class="line"><span class="string">_id:</span><span class="string">"rs1"</span>, </span><br><span class="line"><span class="string">members:</span>[</span><br><span class="line">&#123; <span class="string">_id:</span><span class="number">0</span>, <span class="string">host:</span><span class="string">"192.168.1.78:27017"</span>&#125;</span><br><span class="line">]&#125;</span><br><span class="line">rs.initiate( rscfg )</span><br></pre></td></tr></table></figure></p><p>多节点初始化:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rscfg = &#123; </span><br><span class="line"><span class="string">_id:</span><span class="string">"rs1"</span>, </span><br><span class="line"><span class="string">members:</span>[</span><br><span class="line">&#123; <span class="string">_id:</span><span class="number">0</span>, <span class="string">host:</span><span class="string">"192.168.1.71:27017"</span>, <span class="string">priority:</span><span class="number">2</span>&#125;,</span><br><span class="line">&#123; <span class="string">_id:</span><span class="number">1</span>, <span class="string">host:</span><span class="string">"192.168.1.82:27018"</span>, <span class="string">priority:</span><span class="number">1</span>&#125;,</span><br><span class="line">&#123; <span class="string">_id:</span><span class="number">2</span>, <span class="string">host:</span><span class="string">"192.168.1.71:27019"</span>, <span class="string">arbiterOnly:</span><span class="literal">true</span>&#125;</span><br><span class="line">]&#125;</span><br><span class="line">rs.initiate( rscfg )</span><br></pre></td></tr></table></figure></p><p>2.2 单节点初始化后：添加、删除节点操作<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">添加secondary：rs.<span class="builtin-name">add</span>(&#123;host: <span class="string">"192.168.1.78:27018"</span>, priority: 1 &#125;)</span><br><span class="line">添加仲裁点：rs.addArb(<span class="string">"192.168.1.78:27019"</span>)</span><br><span class="line">移除节点：rs.<span class="builtin-name">remove</span>(&#123;host: <span class="string">"192.168.1.78:27019"</span>&#125;)</span><br><span class="line">重置节点权限：</span><br><span class="line"><span class="attribute">conf</span>=rscfg.conf()</span><br><span class="line">conf.members[0].<span class="attribute">priority</span>=2</span><br><span class="line">rs.reconfig(config)</span><br><span class="line">查看集群配置：rs.conf();</span><br><span class="line">查看集群状态：rs.status();</span><br></pre></td></tr></table></figure></p><h2 id="3-添加管理员用户及普通用户-并进行验证-在rs1-PRIMARY上操作"><a href="#3-添加管理员用户及普通用户-并进行验证-在rs1-PRIMARY上操作" class="headerlink" title="3   添加管理员用户及普通用户,并进行验证(在rs1:PRIMARY上操作)"></a>3   添加管理员用户及普通用户,并进行验证(在rs1:PRIMARY上操作)</h2><p><strong>注意：</strong>需要在主节点(PRIMARY)操作;帐号是跟着库走的，所以在指定库里授权，必须也在指定库里验证(auth)<br>创建用户管理员:<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">admin = db.getSiblingDB(<span class="string">"admin"</span>); <span class="meta">#其中getSiblingDB为获取另一个数据库对象</span></span><br><span class="line">admin.createUser(</span><br><span class="line">  &#123;</span><br><span class="line"><span class="symbol">    user:</span> <span class="string">"admin"</span>,</span><br><span class="line"><span class="symbol">    pwd:</span> <span class="string">"admin"</span>,</span><br><span class="line"><span class="symbol">    roles:</span> [ &#123; role: <span class="string">"userAdminAnyDatabase"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">admin.auth(<span class="string">"admin"</span>, <span class="string">"admin"</span> );</span><br></pre></td></tr></table></figure></p><p>创建集群管理员:<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">admin</span><span class="selector-class">.createUser</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attribute">user</span>: <span class="string">"username"</span>,</span><br><span class="line">    <span class="attribute">pwd</span>: <span class="string">"pwd"</span>,</span><br><span class="line">    <span class="attribute">roles</span>: [ &#123; <span class="attribute">role</span>: <span class="string">"clusterAdmin"</span>, <span class="attribute">db</span>: <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"><span class="selector-tag">admin</span><span class="selector-class">.auth</span>(<span class="string">"username"</span>, <span class="string">"pwd"</span> );</span><br></pre></td></tr></table></figure></p><p>其他用户相关操作</p><ul><li>更新用户：db.getSiblingDB(“admin”);updateUser(“username”,{roles: [ { role: “userAdminAnyDatabase”, db: “admin” } ]})</li><li>验证用户：db.getSiblingDB(“admin”).auth(“username”, “pwd” )</li><li>修改密码：db.changeUserPassword(“username”,”pwd”);</li><li><p>集群及其他角色授权：</p><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.grantRolesToUser( <span class="string">"admin"</span> , [ &#123; <span class="string">"role"</span>: <span class="string">"clusterAdmin"</span>, <span class="string">"db"</span>: <span class="string">"admin"</span> &#125;,</span><br><span class="line">&#123; <span class="string">"role"</span>: <span class="string">"userAdminAnyDatabase"</span>, <span class="string">"db"</span>: <span class="string">"admin"</span> &#125;,</span><br><span class="line">&#123; <span class="string">"role"</span>: <span class="string">"dbAdminAnyDatabase"</span>, <span class="string">"db"</span>: <span class="string">"admin"</span> &#125;,</span><br><span class="line">&#123; role: <span class="string">"root"</span>, db: <span class="string">"admin"</span> &#125; ])</span><br></pre></td></tr></table></figure></li><li><p>如果是admin，可以额外添加：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attribute">role</span>: <span class="string">"dbOwner"</span>, db: <span class="string">"admin"</span> &#125;</span><br></pre></td></tr></table></figure></li></ul><p>加上dbOwner可以直接操作其他数据库如replSetTest，不需要重新认证 db.auth(‘admin’,’admin’)</p><h2 id="4-重启集群"><a href="#4-重启集群" class="headerlink" title="4   重启集群"></a>4   重启集群</h2><p>由于关闭主节点，则主节点状态会切到副本集中的从节点，因此，先关闭从节点，最后关闭主节点。<br>db.getSiblingDB(“admin”).shutdownServer(); 或ps -ef | grep mongo, kill +pid</p><p>取消所有节点配置文件中的注释，<code>keyFile=/usr/local/mongodb_arbiter/keyFile</code>重新启动服务</p><p>如果启动异常，删除mongo.lock, rm -f mongo.lock，重新启动</p><h2 id="5-验证"><a href="#5-验证" class="headerlink" title="5   验证"></a>5   验证</h2><p>登录主节点：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">rs1:</span>PRIMARY&gt;rs.status();</span><br><span class="line">显示：not authorized <span class="keyword">for</span> query</span><br><span class="line"><span class="string">rs1:</span>PRIMARY&gt;db.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"username"</span>, <span class="string">"pwd"</span> );</span><br><span class="line">授权后，可进行操作</span><br><span class="line"><span class="string">rs1:</span>PRIMARY&gt;db.t1.insert(&#123;<span class="string">"name"</span>:<span class="string">"zs"</span>,<span class="string">"age"</span>:<span class="number">11</span>&#125;)</span><br></pre></td></tr></table></figure></p><p>登录从节点查看是否同步：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rs1:SECONDARY&gt;<span class="keyword">db</span>.t1.find() #显示：not authorized <span class="keyword">for</span> <span class="keyword">query</span> <span class="keyword">on</span> <span class="keyword">test</span>.t1"</span><br><span class="line">rs1:SECONDARY&gt;<span class="keyword">db</span>.getSiblingDB(<span class="string">"admin"</span>).auth(<span class="string">"username"</span>, <span class="string">"pwd"</span> ); #验证</span><br><span class="line">rs1:SECONDARY&gt;<span class="keyword">db</span>.t1.find(); #not master and slaveOk=false"</span><br><span class="line">rs1:SECONDARY&gt;<span class="keyword">db</span>.setSlaveOk(); #读权限</span><br><span class="line">rs1:SECONDARY&gt;<span class="keyword">db</span>.t1.find(); #查询所有记录</span><br></pre></td></tr></table></figure></p><p><strong> 注意：</strong>授权操作过程</p><p>rs1:PRIMARY&gt;rs.conf() # 访问异常,not authorized for query on test.t1”<br>rs1:PRIMARY&gt;use admin #切换数据库<br>rs1:PRIMARY&gt;db.auth(“username”, “pwd” ); #授权<br>rs1:PRIMARY&gt;use test #切换其他库<br>rs1:PRIMARY&gt;rs.conf() #正常访问</p><h2 id="6-java测试副本集连接代码"><a href="#6-java测试副本集连接代码" class="headerlink" title="6   java测试副本集连接代码"></a>6   java测试副本集连接代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMongo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MongoClient mongoClient = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DB <span class="title">getDB</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DB conn = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mongoClient == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            intializeMongoClient();</span><br><span class="line">        &#125;</span><br><span class="line">        conn = mongoClient.getDB(<span class="string">"testdb"</span>);</span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">intializeMongoClient</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        MongoClientURI mongoClientURI = <span class="keyword">new</span>  MongoClientURI(<span class="string">"mongodb://username:pwd@192.168.1.78: 27017,192.168.1.78: 27018,192.168.1.78: 27019/admin"</span>);</span><br><span class="line"><span class="comment">//        MongoClientURI mongoClientURI = new MongoClientURI("mongodb://192.168.1.78: 27017");</span></span><br><span class="line">        mongoClient = <span class="keyword">new</span> MongoClient(mongoClientURI);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">closeConnection</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mongoClient != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mongoClient.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        TestMongo testMongo = <span class="keyword">new</span> TestMongo();</span><br><span class="line">        DBObject content=<span class="keyword">new</span> BasicDBObject();</span><br><span class="line">        content.put(<span class="string">"name"</span>,<span class="string">"北京4"</span>);</span><br><span class="line">        content.put(<span class="string">"type"</span>,<span class="string">"首都"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            DB db = testMongo.getDB();</span><br><span class="line">            DBCollection collection=db.getCollection(<span class="string">"n1"</span>);</span><br><span class="line">            collection.insert(content);</span><br><span class="line">            <span class="keyword">long</span> count = collection.getCount();</span><br><span class="line">            System.out.println(count);</span><br><span class="line">            testMongo.closeConnection();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (UnknownHostException e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ol><li><a href="https://docs.mongodb.com/manual/tutorial/enforce-keyfile-access-control-in-existing-replica-set/#enforce-keyfile-access-control-on-existing-replica-set" target="_blank" rel="noopener">Enforce Keyfile Access Control in a Replica Set</a></li><li><a href="https://docs.mongodb.com/v2.6/tutorial/enable-authentication-in-sharded-cluster/" target="_blank" rel="noopener">Enable Authentication in a Sharded Cluster</a></li><li><a href="https://blog.51cto.com/lovelace/1441047" target="_blank" rel="noopener">mongodb之replSet复制集 + auth</a></li><li><a href="https://www.cnblogs.com/Joans/p/7724144.html" target="_blank" rel="noopener">mongodb副本集用户权限设置 </a></li><li><a href="https://www.bbsmax.com/A/obzbY0MVdE/" target="_blank" rel="noopener">Mongodb集群搭建及spring和java连接配置记录</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;准备工作：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;下载mongodb，本次实践版本号mongodb-linux-x86_64-2.6.7.tgz&lt;/li&gt;
&lt;li&gt;设置防火墙为允许&lt;/li&gt;
&lt;li&gt;准备好配置文件，及生成keyFile文件，开启keyFile就相当于开启auth&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="数据库" scheme="https://willwang.top/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="mongodb" scheme="https://willwang.top/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/mongodb/"/>
    
    
      <category term="mongodb" scheme="https://willwang.top/tags/mongodb/"/>
    
  </entry>
  
  <entry>
    <title>Welcome to my blog</title>
    <link href="https://willwang.top/published/2019/03/10/welcome/"/>
    <id>https://willwang.top/published/2019/03/10/welcome/</id>
    <published>2019-03-09T16:00:00.000Z</published>
    <updated>2019-03-10T04:39:26.443Z</updated>
    
    <content type="html"><![CDATA[<p>欢迎访问我的博客，希望留下你美丽的足记。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;欢迎访问我的博客，希望留下你美丽的足记。&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="欢迎" scheme="https://willwang.top/tags/%E6%AC%A2%E8%BF%8E/"/>
    
  </entry>
  
</feed>
